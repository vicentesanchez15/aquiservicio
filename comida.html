<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Comida • Aquiservicio</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0b1220; --navy2:#0f1a33;
      --txt:#0f172a; --mut:#64748b;
      --card:rgba(255,255,255,.94);
      --glow:rgba(56,189,248,.22);
      --shadow:0 20px 70px rgba(2,6,23,.18);
      --r:20px;
      --green:#16a34a;
      --greenBg:rgba(34,197,94,.12);
      --greenBd:rgba(34,197,94,.28);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(56,189,248,.14), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(99,102,241,.12), transparent 55%),
        linear-gradient(180deg, var(--navy), var(--navy2));
      min-height:100vh;
      display:flex;
      justify-content:center;
      padding:18px;
    }
    .shell{width:min(980px,100%)}
    .card{
      margin-top:10px;
      background:var(--card);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:var(--shadow);
      border-radius: calc(var(--r) + 10px);
      overflow:hidden;
      backdrop-filter: blur(10px);
      animation: in .35s ease-out;
    }
    @keyframes in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .main{padding:16px 12px 18px}

    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .back{
      text-decoration:none;font-weight:900;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;padding:10px 12px;border-radius:999px;color:var(--txt);
      display:inline-flex;gap:8px;align-items:center;
    }
    .title{
      margin:0;
      font-weight:900;
      font-size:22px;
      letter-spacing:.02em;
      background: linear-gradient(90deg, rgba(56,189,248,.9), rgba(99,102,241,.9));
      -webkit-background-clip:text;background-clip:text;color:transparent;
      animation: shimmer 2.8s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%,100%{filter:saturate(1)}
      50%{filter:saturate(1.25)}
    }
    .sub{margin:2px 0 0;color:rgba(15,23,42,.70);font-weight:750;font-size:13px}

    .searchRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .search{
      flex:1;
      min-width:220px;
      border-radius:16px;
      padding:12px 12px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      font-weight:800;
      outline:none;
    }
    .search:focus{box-shadow:0 0 0 4px var(--glow);border-color: rgba(56,189,248,.35);}
    .pill{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      color:rgba(15,23,42,.75);
      white-space:nowrap;
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(min-width:760px){
      .grid{grid-template-columns: 1fr 1fr 1fr 1fr;}
    }

    .catBtn{
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      overflow:hidden;
      text-decoration:none;
      color:var(--txt);
      box-shadow: 0 12px 28px rgba(2,6,23,.08);
      transition: transform .12s ease, box-shadow .12s ease;
      display:block;
    }
    .catBtn:hover{transform:translateY(-1px); box-shadow:0 16px 40px rgba(2,6,23,.12);}
    .catBtn:active{transform:scale(.99);}
    .catImg{width:100%; height:110px; object-fit:cover; display:block;}
    .catName{padding:10px 10px; font-weight:900; font-size:14px; text-align:center;}

    .panel{
      margin-top:14px;
      border-radius:20px;
      border:1px solid rgba(56,189,248,.25);
      background: linear-gradient(180deg, rgba(56,189,248,.08), rgba(99,102,241,.05));
      padding:12px;
      display:none;
    }
    .panelTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px;
    }
    .panelTitle{margin:0;font-weight:900;font-size:16px}
    .closeBtn{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }

    .list{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){ .list{grid-template-columns:1fr 1fr;} }

    .biz{
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      padding:12px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .bizTop{display:flex;align-items:flex-start;justify-content:space-between;gap:10px}
    .bizName{margin:0;font-weight:900;font-size:15px}
    .badge{
      font-weight:900;
      font-size:12px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(15,23,42,.10);
      background:rgba(2,6,23,.03);
      color:rgba(15,23,42,.75);
      white-space:nowrap;
    }
    .badge.ok{
      border-color:var(--greenBd);
      background:var(--greenBg);
      color:var(--green);
    }
    .bizMeta{margin-top:6px;color:rgba(15,23,42,.70);font-weight:750;font-size:13px;line-height:1.45}
    .bizFlags{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
    .flag{
      font-weight:900;font-size:12px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;color:rgba(15,23,42,.75);
    }
    .bizActions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    .act{
      text-decoration:none;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      color:var(--txt);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .act.primary{
      background: linear-gradient(180deg, rgba(56,189,248,.16), rgba(99,102,241,.10));
      border-color: rgba(56,189,248,.35);
    }

    .empty{
      text-align:center;
      font-weight:900;
      color:rgba(15,23,42,.75);
      padding:18px 10px;
      border-radius:18px;
      background:rgba(255,255,255,.65);
      border:1px dashed rgba(15,23,42,.18);
      animation: floaty 2.2s ease-in-out infinite;
    }
    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}

    .foot{
      margin-top:12px;text-align:center;font-size:12px;color:rgba(255,255,255,.65);font-weight:800;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="main">
        <div class="top">
          <a class="back" href="index.html">← Inicio</a>
          <div style="text-align:center;flex:1">
            <h1 class="title">Comida</h1>
            <p class="sub">Busca por categoría o escribe lo que quieres.</p>
          </div>
          <div style="width:84px"></div>
        </div>

        <div class="searchRow">
          <input id="q" class="search" placeholder="Buscar… ej: tortas, carne asada, sushi" />
          <span class="pill" id="locPill">Navolato</span>
        </div>

        <div class="grid" id="cats"></div>

        <div class="panel" id="panel">
          <div class="panelTop">
            <h3 class="panelTitle" id="panelTitle">Resultados</h3>
            <button class="closeBtn" id="close">✕</button>
          </div>
          <div id="panelBody" class="list"></div>
        </div>

      </div>
    </div>

    <div class="foot">Aquiservicio • Hecho para Sinaloa</div>
  </div>

  <script>
    const CATS = [
      { key:"abierto",   label:"Abierto",    img:"assets/categoria/abierto.webp", mode:"open" },
      { key:"promos",    label:"Promociones",img:"assets/categoria/promos.webp",  mode:"promos" },

      { key:"tacos",     label:"Tacos",      img:"assets/categoria/tacos.webp",   offer:"tacos" },
      { key:"torta",     label:"Tortas",     img:"assets/categoria/torta.webp",   offer:"tortas" },
      { key:"hamburguesa",label:"Hamburguesas",img:"assets/categoria/hamburguesa.webp", offer:"hamburguesas" },
      { key:"pizza",     label:"Pizza",      img:"assets/categoria/pizza.webp",   offer:"pizza" },
      { key:"sushi",     label:"Sushi",      img:"assets/categoria/sushi.webp",   offer:"sushi" },
      { key:"mariscos",  label:"Mariscos",   img:"assets/categoria/mariscos.webp",offer:"mariscos" },
      { key:"pollo",     label:"Pollo asado",img:"assets/categoria/pollo.webp",   offer:"pollo-asado" },
      { key:"cafe",      label:"Café y postres",img:"assets/categoria/cafe.webp", offer:"cafe-y-postres" },
    ];

    const $ = (id)=>document.getElementById(id);
    const catsEl = $("cats");
    const panel = $("panel");
    const panelTitle = $("panelTitle");
    const panelBody = $("panelBody");
    const qEl = $("q");
    const locPill = $("locPill");

    function getMunicipality(){
      return localStorage.getItem("aq_city") || "Navolato";
    }
    function getLocality(){
      const m = getMunicipality();
      return localStorage.getItem("aq_locality_" + m) || "";
    }
    function waLink(num){
      const n = String(num||"").replace(/\D/g,"");
      return n ? ("https://wa.me/52" + n) : "#";
    }
    function telLink(num){
      const n = String(num||"").replace(/\D/g,"");
      return n ? ("tel:" + n) : "#";
    }

    function renderCats(){
      catsEl.innerHTML = "";
      for(const c of CATS){
        const a = document.createElement("a");
        a.href="#";
        a.className="catBtn";
        a.innerHTML = `
          <img class="catImg" src="${c.img}" alt="${c.label}">
          <div class="catName">${c.label}</div>
        `;
        a.addEventListener("click",(e)=>{
          e.preventDefault();
          openCategory(c);
        });
        catsEl.appendChild(a);
      }
    }

    function showPanel(title){
      panelTitle.textContent = title;
      panel.style.display = "block";
      panel.scrollIntoView({behavior:"smooth", block:"start"});
    }
    function closePanel(){
      panel.style.display = "none";
      panelBody.innerHTML = "";
    }
    $("close").addEventListener("click", closePanel);

    function card(b){
      const verified = !!b.verified;
      const flags = [];
      if (b.delivery) flags.push("Domicilio");
      if (b.pickup) flags.push("Ordena y recoge");
      if (b.dine_in) flags.push("Sucursal");

      return `
        <div class="biz">
          <div class="bizTop">
            <h4 class="bizName">${escapeHtml(b.name || "")}</h4>
            <span class="badge ${verified ? "ok":""}">${verified ? "Verificado" : "Sin verificar"}</span>
          </div>
          <div class="bizMeta">
            <b>${escapeHtml(b.category_primary || "Comida")}</b> • ${escapeHtml(b.locality || "")}
            ${b.description ? "<br>" + escapeHtml(b.description) : ""}
          </div>
          ${flags.length ? `<div class="bizFlags">${flags.map(f=>`<span class="flag">${f}</span>`).join("")}</div>` : ""}
          <div class="bizActions">
            <a class="act primary" href="${waLink(b.whatsapp)}" target="_blank" rel="noopener">WhatsApp</a>
            ${b.phone ? `<a class="act" href="${telLink(b.phone)}">Llamar</a>` : ""}
          </div>
        </div>
      `;
    }

    function emptyMsg(text){
      return `<div class="empty">${text}</div>`;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function fetchBusinesses({offer=null, q=null}){
      const municipality = getMunicipality();
      const locality = getLocality();
      const url = new URL("/api/search", location.origin);
      url.searchParams.set("kind", "food");
      url.searchParams.set("municipality", municipality);
      if (locality) url.searchParams.set("locality", locality);
      if (offer) url.searchParams.set("offer", offer);
      if (q) url.searchParams.set("q", q);

      const r = await fetch(url.toString());
      const out = await r.json();
      if(!r.ok || out.error) throw new Error(out.error || ("HTTP "+r.status));
      return out.data || [];
    }

    async function fetchPromos(){
      const municipality = getMunicipality();
      const locality = getLocality();
      const url = new URL("/api/promotions", location.origin);
      url.searchParams.set("kind", "food");
      url.searchParams.set("municipality", municipality);
      if (locality) url.searchParams.set("locality", locality);

      const r = await fetch(url.toString());
      const out = await r.json();
      if(!r.ok || out.error) throw new Error(out.error || ("HTTP "+r.status));
      return out.data || [];
    }

    async function openCategory(cat){
      const municipality = getMunicipality();
      const locality = getLocality();
      locPill.textContent = locality ? (municipality + " • " + locality) : municipality;

      showPanel(cat.label);
      panelBody.innerHTML = emptyMsg("Cargando…");

      try{
        if(cat.mode === "promos"){
          const promos = await fetchPromos();
          if(!promos.length){
            panelBody.innerHTML = emptyMsg("Por el momento no existen promociones disponibles ✨");
            return;
          }
          panelBody.innerHTML = promos.map(p => {
            const b = p.business || {};
            return `
              <div class="biz">
                <div class="bizTop">
                  <h4 class="bizName">${escapeHtml(b.name || "Promoción")}</h4>
                  <span class="badge ok">Verificado</span>
                </div>
                <div class="bizMeta">${escapeHtml(p.text || "")}</div>
                <div class="bizActions">
                  <a class="act primary" href="${waLink(b.whatsapp)}" target="_blank" rel="noopener">WhatsApp</a>
                  ${b.phone ? `<a class="act" href="${telLink(b.phone)}">Llamar</a>` : ""}
                </div>
              </div>
            `;
          }).join("");
          return;
        }

        // Abierto (por ahora = aprobados; luego metemos horarios reales)
        const q = qEl.value.trim();
        const rows = await fetchBusinesses({ offer: cat.offer || null, q: q || null });

        if(!rows.length){
          panelBody.innerHTML = emptyMsg("Por el momento no hay resultados aquí ✨");
          return;
        }
        panelBody.innerHTML = rows.map(card).join("");

      }catch(e){
        panelBody.innerHTML = emptyMsg("Error: " + escapeHtml(e.message || "No se pudo cargar"));
      }
    }

    // Buscar: si escribe, muestra panel con resultados del texto (sin categoría)
    let t = null;
    qEl.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(async ()=>{
        const q = qEl.value.trim();
        if(!q) return;
        showPanel("Resultados");
        panelBody.innerHTML = emptyMsg("Buscando…");
        try{
          const rows = await fetchBusinesses({ q });
          panelBody.innerHTML = rows.length ? rows.map(card).join("") : emptyMsg("No encontré nada con esa búsqueda ✨");
        }catch(e){
          panelBody.innerHTML = emptyMsg("Error: " + escapeHtml(e.message || "No se pudo buscar"));
        }
      }, 250);
    });

    renderCats();
    // Actualiza pill al entrar
    (function(){
      const m = getMunicipality();
      const l = getLocality();
      locPill.textContent = l ? (m + " • " + l) : m;
    })();
  </script>
</body>
</html>
