<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comida ‚Ä¢ Aquiservicio</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0b1220;
      --navy2:#0f1a33;

      --txt:#0f172a;
      --mut:#64748b;

      --card:rgba(255,255,255,.94);
      --shadow:0 20px 70px rgba(2,6,23,.18);
      --r:20px;

      --glow:rgba(56,189,248,.22);

      --green:#16a34a;
      --greenBg:rgba(34,197,94,.12);
      --greenBd:rgba(34,197,94,.28);

      --chipBg:rgba(2,6,23,.04);
      --chipBd:rgba(15,23,42,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(56,189,248,.14), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(99,102,241,.12), transparent 55%),
        linear-gradient(180deg, var(--navy), var(--navy2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .shell{width:min(980px, 100%);}
    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      border-radius: calc(var(--r) + 10px);
      overflow:hidden;
      backdrop-filter: blur(10px);
      animation: in .35s ease-out;
    }
    @keyframes in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .main{padding:14px 12px 16px}

    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:6px 4px 10px;
    }
    .btn{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      font-size:13px;
      text-decoration:none;
      color:var(--txt);
      user-select:none;
    }
    .logo{
      height:22px;
      transform: translateX(-6px);
      display:block;
    }

    .titleWrap{
      text-align:center;
      padding:6px 4px 10px;
    }
    .title{
      margin:0;
      font-weight:900;
      letter-spacing:.18em;
      font-size:20px;
      text-transform:uppercase;
      background: linear-gradient(90deg, rgba(56,189,248,.92), rgba(99,102,241,.92));
      -webkit-background-clip:text;background-clip:text;color:transparent;
      animation: shimmer 3.2s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%,100%{filter:brightness(1)}
      50%{filter:brightness(1.2)}
    }
    .sub{
      margin:6px 0 0;
      color: rgba(15,23,42,.72);
      font-weight:800;
      font-size:13.5px;
      line-height:1.35;
    }

    .controls{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
      padding:0 4px;
    }
    @media(min-width:720px){
      .controls{grid-template-columns: 260px 1fr;}
    }

    .selectBox, .searchBox{
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      padding:10px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .label{
      font-size:12px;
      font-weight:900;
      color: rgba(15,23,42,.70);
      text-transform:uppercase;
      letter-spacing:.06em;
      margin-bottom:6px;
    }
    select, input{
      width:100%;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid rgba(15,23,42,.14);
      font-weight:850;
      font-size:14px;
      outline:none;
      font-family:inherit;
    }
    select:focus, input:focus{
      box-shadow:0 0 0 4px var(--glow);
      border-color: rgba(56,189,248,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
      padding:0 4px;
    }

    .cat{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      box-shadow: 0 12px 28px rgba(2,6,23,.08);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease;
      min-height:120px;
    }
    .cat:hover{transform:translateY(-1px);box-shadow: 0 16px 40px rgba(2,6,23,.12);}
    .cat:active{transform:scale(.99);}

    .cat img{
      width:100%;
      height:120px;
      object-fit:cover;
      display:block;
      filter: saturate(1.05) contrast(1.02);
    }
    .cat .cap{
      padding:10px 10px 12px;
      font-weight:900;
      font-size:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cap small{
      font-weight:900;
      font-size:12px;
      color: rgba(15,23,42,.62);
    }

    .expanded{
      grid-column: 1 / -1;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
      border-radius:18px;
      padding:12px;
      box-shadow: 0 14px 40px rgba(2,6,23,.10);
      animation: pop .18s ease-out;
    }
    @keyframes pop{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

    .expTop{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      margin-bottom:10px;
    }
    .expTitle{
      font-weight:900;
      font-size:16px;
      margin:0;
    }
    .xbtn{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
    }

    .list{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .biz{
      border:1px solid rgba(15,23,42,.10);
      border-radius:16px;
      padding:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      background: rgba(2,6,23,.02);
    }
    .biz img{
      width:56px;height:56px;border-radius:14px;object-fit:cover;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      flex:0 0 auto;
    }
    .biz .n{font-weight:900}
    .biz .d{margin-top:4px;color:rgba(15,23,42,.72);font-weight:750;font-size:13px;line-height:1.35}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:12px;
      border:1px solid var(--chipBd);
      background: var(--chipBg);
      color: rgba(15,23,42,.78);
      white-space:nowrap;
    }
    .badge.green{border-color:var(--greenBd);background:var(--greenBg);color:var(--green);}
    .badge.promo{background: rgba(56,189,248,.14); border-color: rgba(56,189,248,.28);}

    .act{
      margin-left:auto;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .mini{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:999px;
      padding:9px 11px;
      font-weight:900;
      font-size:13px;
      text-decoration:none;
      color:var(--txt);
    }

    .empty{
      text-align:center;
      padding:14px 10px;
      border:1px dashed rgba(15,23,42,.18);
      border-radius:16px;
      color:rgba(15,23,42,.72);
      font-weight:900;
      background: rgba(2,6,23,.02);
    }
    .pulse{
      display:inline-block;
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{transform:translateY(0);opacity:.85}
      50%{transform:translateY(-4px);opacity:1}
    }

    .bottom{
      display:flex;justify-content:center;
      margin-top:12px;
      padding-bottom:4px;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="card">
      <div class="main">

        <div class="top">
          <a class="btn" href="index.html">‚Üê Inicio</a>
          <img class="logo" src="assets/logo.svg" alt="aquiservicio.com">
          <span style="width:84px"></span>
        </div>

        <div class="titleWrap">
          <h1 class="title">COMIDA</h1>
          <p class="sub">Filtra por localidad y busca r√°pido lo que se te antoja.</p>
        </div>

        <div class="controls">
          <div class="selectBox">
            <div class="label">Localidad</div>
            <select id="locality">
              <option value="" selected>Todas</option>
              <option>Navolato Centro</option>
              <option>Altata</option>
              <option>La Palma</option>
              <option>Villa Ju√°rez</option>
              <option>San Pedro</option>
              <option>Dautillos</option>
              <option>El Castillo</option>
              <option>El Tigre</option>
              <option>Las Aguamitas</option>
              <option>Yameto</option>
            </select>
          </div>

          <div class="searchBox">
            <div class="label">Buscar</div>
            <input id="q" placeholder="Ej: tacos, tortas, sushi, mariscos‚Ä¶" />
          </div>
        </div>

        <div class="grid" id="grid"></div>

        <div class="bottom">
          <a class="btn" href="index.html">‚Üê Inicio</a>
        </div>

      </div>
    </div>
  </div>

  <script>
    const grid = document.getElementById("grid");
    const localitySel = document.getElementById("locality");
    const qInput = document.getElementById("q");

    const MUNICIPALITY = "Navolato";

    const categories = [
      { key:"abierto",  label:"Abierto",       img:"assets/categoria/abierto.webp", mode:"open" },
      { key:"promos",   label:"Promociones",   img:"assets/categoria/promos.webp",  mode:"promos" },

      { key:"tacos",    label:"Tacos",         img:"assets/categoria/tacos.webp" },
      { key:"torta",    label:"Tortas",        img:"assets/categoria/torta.webp" },
      { key:"hamburguesa", label:"Hamburguesas", img:"assets/categoria/hamburguesa.webp" },
      { key:"pizza",    label:"Pizza",         img:"assets/categoria/pizza.webp" },
      { key:"sushi",    label:"Sushi",         img:"assets/categoria/sushi.webp" },
      { key:"mariscos", label:"Mariscos",      img:"assets/categoria/mariscos.webp" },
      { key:"pollo",    label:"Pollo asado",   img:"assets/categoria/pollo.webp" },
      { key:"cafe",     label:"Caf√© y postre", img:"assets/categoria/cafe.webp" }
    ];

    function esc(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function waLink(wa){
      const w = String(wa||"").replace(/\D/g,"");
      return w ? ("https://wa.me/52"+w) : "#";
    }
    function telLink(p){
      const t = String(p||"").replace(/\D/g,"");
      return t ? ("tel:"+t) : "#";
    }

    function renderCats(){
      grid.innerHTML = "";
      categories.forEach(c=>{
        const el = document.createElement("div");
        el.className = "cat";
        el.dataset.key = c.key;

        el.innerHTML = `
          <img src="${c.img}" alt="${esc(c.label)}">
          <div class="cap">
            <div>${esc(c.label)}</div>
            <small>Ver ‚Üí</small>
          </div>
        `;

        el.addEventListener("click", ()=>openCategory(c, el));
        grid.appendChild(el);
      });
    }

    let expandedEl = null;

    function closeExpanded(){
      if(expandedEl){
        expandedEl.remove();
        expandedEl = null;
      }
    }

    async function openCategory(cat, afterEl){
      if(expandedEl && expandedEl.dataset.openKey === cat.key){
        closeExpanded();
        return;
      }
      closeExpanded();

      const box = document.createElement("div");
      box.className = "expanded";
      box.dataset.openKey = cat.key;
      box.innerHTML = `
        <div class="expTop">
          <div>
            <p class="expTitle">${esc(cat.label)}</p>
            <div style="color:rgba(15,23,42,.72);font-weight:850;font-size:13px;margin-top:4px">
              ${cat.mode==="open" ? "Negocios abiertos en este momento." :
                cat.mode==="promos" ? "Promociones del d√≠a (solo verificados con plan)." :
                "Resultados de esta categor√≠a (verificados primero)."}
            </div>
          </div>
          <button class="xbtn" aria-label="Cerrar">‚úï</button>
        </div>
        <div id="content"></div>
      `;
      box.querySelector(".xbtn").addEventListener("click", closeExpanded);

      afterEl.insertAdjacentElement("afterend", box);
      expandedEl = box;

      const content = box.querySelector("#content");
      content.innerHTML = `<div class="empty"><span class="pulse">‚è≥ Cargando‚Ä¶</span></div>`;

      try{
        const loc = localitySel.value || "";
        const q = (qInput.value || "").trim();

        // 1) ABIERTO
        if(cat.mode === "open"){
          const url = new URL(location.origin + "/api/public_list");
          url.searchParams.set("kind","food");
          url.searchParams.set("municipality", MUNICIPALITY);
          if(loc) url.searchParams.set("locality", loc);
          url.searchParams.set("open","1");

          const r = await fetch(url.toString());
          const out = await r.json();
          if(!r.ok || out.error) throw new Error(out.error || "Error");

          renderBusinesses(content, out.data, {
            emptyText: "Por el momento no hay negocios abiertos aqu√≠ üòÖ"
          });
          return;
        }

        // 2) PROMOS (REAL)
        if(cat.mode === "promos"){
          const url = new URL(location.origin + "/api/public_promos");
          url.searchParams.set("municipality", MUNICIPALITY);
          if(loc) url.searchParams.set("locality", loc);

          const r = await fetch(url.toString());
          const out = await r.json();
          if(!r.ok || out.error) throw new Error(out.error || "Error");

          renderPromos(content, out.data, {
            emptyText: "üéâ Por el momento no existen promociones disponibles"
          });
          return;
        }

        // 3) CATEGOR√çA NORMAL
        const url = new URL(location.origin + "/api/public_list");
        url.searchParams.set("kind","food");
        url.searchParams.set("municipality", MUNICIPALITY);
        if(loc) url.searchParams.set("locality", loc);

        if(q) url.searchParams.set("q", q);
        else url.searchParams.set("category", cat.key);

        const r = await fetch(url.toString());
        const out = await r.json();
        if(!r.ok || out.error) throw new Error(out.error || "Error");

        renderBusinesses(content, out.data, {
          emptyText: "No encontramos resultados aqu√≠ üòï"
        });

      }catch(e){
        content.innerHTML = `<div class="empty"><span class="pulse">‚ö†Ô∏è ${esc(e.message || "Error")}</span></div>`;
      }
    }

    function renderBusinesses(container, list, opts){
      const arr = Array.isArray(list) ? list : [];
      if(!arr.length){
        container.innerHTML = `
          <div class="empty">
            <span class="pulse">${esc(opts?.emptyText || "Sin resultados")}</span>
          </div>
        `;
        return;
      }

      const wrap = document.createElement("div");
      wrap.className = "list";

      for(const b of arr){
        const img = b.profile_photo_url ? b.profile_photo_url : "assets/categoria/abierto.webp";
        const badges = [];

        if(b.verified) badges.push(`<span class="badge green">‚úÖ VERIFICADO</span>`);
        if(b.status_text) badges.push(`<span class="badge">${esc(b.status_text)}</span>`);

        if(b.delivery) badges.push(`<span class="badge">üöö Domicilio</span>`);
        if(b.pickup) badges.push(`<span class="badge">üõçÔ∏è Ordena y recoge</span>`);
        if(b.dine_in) badges.push(`<span class="badge">üè™ Sucursal</span>`);

        const card = document.createElement("div");
        card.className = "biz";
        card.innerHTML = `
          <img src="${esc(img)}" alt="">
          <div style="min-width:0;flex:1">
            <div class="n">${esc(b.name)}</div>
            <div class="d">${esc((b.description||"").slice(0,140))}</div>
            <div class="row">${badges.join("")}</div>
            <div class="row">
              <span class="badge">${esc(b.locality || "")}</span>
              <div class="act">
                <a class="mini" href="${esc(waLink(b.whatsapp))}" target="_blank" rel="noopener">WhatsApp</a>
                <a class="mini" href="${esc(telLink(b.phone || b.whatsapp))}">Llamar</a>
              </div>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      }

      container.innerHTML = "";
      container.appendChild(wrap);
    }

    function renderPromos(container, list, opts){
      const arr = Array.isArray(list) ? list : [];
      if(!arr.length){
        container.innerHTML = `
          <div class="empty">
            <span class="pulse">${esc(opts?.emptyText || "Sin promos")}</span>
          </div>
        `;
        return;
      }

      const wrap = document.createElement("div");
      wrap.className = "list";

      for(const row of arr){
        const b = row.business || {};
        const img = b.profile_photo_url ? b.profile_photo_url : "assets/categoria/promos.webp";

        const badges = [];
        badges.push(`<span class="badge green">‚úÖ VERIFICADO</span>`);
        badges.push(`<span class="badge promo">üéâ ${esc(row.promo_text || "")}</span>`);
        if(b.delivery) badges.push(`<span class="badge">üöö Domicilio</span>`);
        if(b.pickup) badges.push(`<span class="badge">üõçÔ∏è Ordena y recoge</span>`);
        if(b.dine_in) badges.push(`<span class="badge">üè™ Sucursal</span>`);

        const card = document.createElement("div");
        card.className = "biz";
        card.innerHTML = `
          <img src="${esc(img)}" alt="">
          <div style="min-width:0;flex:1">
            <div class="n">${esc(b.name)}</div>
            <div class="d">${esc((b.description||"").slice(0,120))}</div>
            <div class="row">${badges.join("")}</div>
            <div class="row">
              <span class="badge">${esc(b.locality || "")}</span>
              <div class="act">
                <a class="mini" href="${esc(waLink(b.whatsapp))}" target="_blank" rel="noopener">WhatsApp</a>
                <a class="mini" href="${esc(telLink(b.phone || b.whatsapp))}">Llamar</a>
              </div>
            </div>
          </div>
        `;
        wrap.appendChild(card);
      }

      container.innerHTML = "";
      container.appendChild(wrap);
    }

    localitySel.addEventListener("change", ()=>{
      if(expandedEl){
        const key = expandedEl.dataset.openKey;
        const cat = categories.find(c=>c.key===key);
        const card = document.querySelector(`.cat[data-key="${key}"]`);
        if(cat && card) openCategory(cat, card);
      }
    });

    let t = null;
    qInput.addEventListener("input", ()=>{
      clearTimeout(t);
      t = setTimeout(()=>{
        if(expandedEl){
          const key = expandedEl.dataset.openKey;
          const cat = categories.find(c=>c.key===key);
          const card = document.querySelector(`.cat[data-key="${key}"]`);
          if(cat && card) openCategory(cat, card);
        }
      }, 350);
    });

    renderCats();
  </script>
</body>
</html>
