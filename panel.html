<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Panel • Aquiservicio</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0b1220; --navy2:#0f1a33;
      --txt:#0f172a; --mut:#64748b;
      --card:rgba(255,255,255,.94);
      --shadow:0 20px 70px rgba(2,6,23,.18);
      --r:20px;
      --green:#16a34a; --greenBg:rgba(34,197,94,.12); --greenBd:rgba(34,197,94,.28);
      --glow:rgba(56,189,248,.22);
      --ok:rgba(34,197,94,.12); --okbd:rgba(34,197,94,.30);
      --err:rgba(239,68,68,.12); --errbd:rgba(239,68,68,.30);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--txt);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(56,189,248,.14), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(99,102,241,.12), transparent 55%),
        linear-gradient(180deg, var(--navy), var(--navy2));
      min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;
    }
    .shell{width:min(920px,100%)}
    .card{
      background:var(--card);border:1px solid rgba(255,255,255,.18);box-shadow:var(--shadow);
      border-radius: calc(var(--r) + 10px);overflow:hidden;backdrop-filter: blur(10px);
      animation: in .35s ease-out;
    }
    @keyframes in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .main{padding:16px 14px 18px}

    .top{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .btn{
      border:1px solid rgba(15,23,42,.10);background:#fff;border-radius:999px;
      padding:10px 12px;font-weight:900;cursor:pointer;text-decoration:none;color:var(--txt);
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(56,189,248,.18), rgba(99,102,241,.12));
      border-color: rgba(56,189,248,.35);
    }

    .h{
      margin:12px 0 6px;font-weight:900;font-size:20px;
      background: linear-gradient(90deg, rgba(56,189,248,.9), rgba(99,102,241,.9));
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .sub{margin:0;color:rgba(15,23,42,.72);font-weight:800;font-size:13px;line-height:1.45}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:820px){ .grid{grid-template-columns:1fr 1fr;} }

    .box{
      background:#fff;border:1px solid rgba(15,23,42,.10);border-radius:18px;padding:12px;
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:900;font-size:12px;border-radius:999px;padding:6px 10px;
      border:1px solid rgba(15,23,42,.10);background:rgba(2,6,23,.03);color:rgba(15,23,42,.75);
      white-space:nowrap;
    }
    .badge.ok{border-color:var(--greenBd);background:var(--greenBg);color:var(--green);}

    label{display:block;margin-top:10px;font-size:12px;font-weight:900;color:rgba(15,23,42,.70);text-transform:uppercase}
    input, textarea{
      width:100%;border-radius:16px;padding:12px 12px;border:1px solid rgba(15,23,42,.14);
      background:#fff;font-weight:850;font-size:14px;outline:none;margin-top:6px;font-family:inherit;
    }
    textarea{min-height:96px;resize:vertical}
    input:focus, textarea:focus{box-shadow:0 0 0 4px var(--glow);border-color: rgba(56,189,248,.35);}

    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .chips label{margin:0;display:flex;align-items:center;gap:8px;text-transform:none;color:rgba(15,23,42,.78);font-weight:900}
    .chips input{width:auto;margin:0}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    .msg{
      display:none;margin-top:12px;border-radius:18px;padding:12px;font-weight:900;font-size:13px;text-align:center;
      border:1px solid rgba(15,23,42,.12);background: rgba(2,6,23,.03);
    }
    .msg.ok{background:var(--ok);border-color:var(--okbd)}
    .msg.err{background:var(--err);border-color:var(--errbd)}

    .hint{margin-top:8px;color:rgba(15,23,42,.65);font-weight:850;font-size:12px;line-height:1.45}
    .lock{opacity:.55;pointer-events:none}

    .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .thumb{
      width:86px;height:86px;border-radius:14px;object-fit:cover;border:1px solid rgba(15,23,42,.12);
      background:rgba(2,6,23,.03);
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="main">
        <div class="top">
          <a class="btn" href="index.html">← Inicio</a>
          <img src="assets/logo.svg" alt="aquiservicio.com" style="height:24px;transform:translateX(-6px)">
          <button class="btn" id="logout">Salir</button>
        </div>

        <h1 class="h">Tu panel</h1>
        <p class="sub">Edita tu info. Fotos/promos se activan con plan. Horarios para “Cierra en…” / “Abre en…”.</p>

        <div class="grid">
          <!-- RESUMEN -->
          <div class="box" id="summary">Cargando…</div>

          <!-- EDITAR PERFIL -->
          <div class="box">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="font-weight:900">Editar perfil</div>
              <span class="badge" id="planBadge">Plan: -</span>
            </div>

            <label for="desc">Descripción</label>
            <textarea id="desc" placeholder="Ej: Vendemos tacos y también tortas…"></textarea>

            <label for="cov">Zona de cobertura (opcional)</label>
            <input id="cov" placeholder="Ej: Centro y Altata"/>

            <label for="phone">Tel para llamadas (opcional)</label>
            <input id="phone" placeholder="Ej: 6671234567" inputmode="numeric"/>

            <div class="chips">
              <label><input type="checkbox" id="delivery"> Domicilio</label>
              <label><input type="checkbox" id="pickup"> Ordena y recoge</label>
              <label><input type="checkbox" id="dine"> Sucursal</label>
              <label><input type="checkbox" id="avail"> Disponible ahora (solo servicios)</label>
            </div>

            <div class="actions">
              <button class="btn primary" id="save">Guardar cambios</button>
            </div>

            <div class="msg" id="msg"></div>
          </div>

          <!-- FOTOS (SUBIDA REAL) -->
          <div class="box" id="mediaBox">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="font-weight:900">Fotos</div>
              <span class="badge" id="mediaBadge">Bloqueado</span>
            </div>

            <label>Foto de perfil</label>
            <input id="fileProfile" type="file" accept="image/*"/>
            <div class="actions">
              <button class="btn primary" id="upProfile">Subir foto</button>
            </div>
            <div class="thumbs" id="profilePrev"></div>

            <label>Galería (hasta 5)</label>
            <input id="fileGallery" type="file" accept="image/*"/>
            <div class="actions">
              <button class="btn primary" id="upGallery">Subir a galería</button>
            </div>
            <div class="thumbs" id="galleryPrev"></div>

            <div class="hint">Subida segura con URL firmada (no hay keys en tu navegador).</div>
          </div>

          <!-- HORARIOS -->
          <div class="box" id="hoursBox">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div style="font-weight:900">Horarios</div>
              <span class="badge" id="hoursBadge">—</span>
            </div>

            <div class="hint">Pon tu horario real. Así a la gente le sale “Cierra en…” o “Abre en…”.</div>

            <div id="hoursForm" style="margin-top:10px; display:grid; gap:10px;"></div>

            <div class="actions">
              <button class="btn primary" id="saveHours">Guardar horarios</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    async function checkAuth(){
const r=await fetch("/api/check_auth");
if(!r.ok){
window.location="login.html";
}
}
checkAuth();
    const $ = (id)=>document.getElementById(id);

    function show(text, ok=true){
      const m = $("msg");
      m.style.display="block";
      m.className="msg " + (ok?"ok":"err");
      m.textContent=text;
    }
    function esc(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }
    function cleanPhone(s){ return String(s||"").replace(/\D/g,"").slice(0,15); }

    let ME = null;

    // ---- THUMBS ----
    function renderThumbs(){
      $("profilePrev").innerHTML = "";
      if(ME?.profile_photo_url){
        const img = document.createElement("img");
        img.className="thumb";
        img.src = ME.profile_photo_url;
        $("profilePrev").appendChild(img);
      }

      $("galleryPrev").innerHTML = "";
      const g = Array.isArray(ME?.gallery_urls) ? ME.gallery_urls : [];
      g.filter(Boolean).forEach(u=>{
        const img = document.createElement("img");
        img.className="thumb";
        img.src = u;
        $("galleryPrev").appendChild(img);
      });
    }

    // ---- HORAS ----
    const DOW = [
      { dow:1, name:"Lunes" },
      { dow:2, name:"Martes" },
      { dow:3, name:"Miércoles" },
      { dow:4, name:"Jueves" },
      { dow:5, name:"Viernes" },
      { dow:6, name:"Sábado" },
      { dow:0, name:"Domingo" }
    ];

    function hourRow(d){
      return `
        <div style="display:grid;grid-template-columns: 1fr 90px 90px; gap:10px; align-items:center;">
          <div style="font-weight:900;color:rgba(15,23,42,.78)">${d.name}</div>
          <input type="time" id="o${d.dow}" value="09:00">
          <input type="time" id="c${d.dow}" value="18:00">
        </div>
        <div style="display:flex;gap:10px;align-items:center;margin-top:-4px">
          <label style="margin:0;display:flex;align-items:center;gap:8px;text-transform:none;color:rgba(15,23,42,.78);font-weight:900">
            <input type="checkbox" id="x${d.dow}"> Cerrado este día
          </label>
        </div>
      `;
    }

    async function loadHours(){
      try{
        const r = await fetch("/api/get_hours");
        const out = await r.json().catch(()=>({}));
        if(!r.ok || out.error){
          $("hoursBadge").textContent = "No disponible";
          return;
        }

        $("hoursBadge").textContent = "Listo";
        $("hoursBadge").className = "badge ok";

        const map = new Map((out.data||[]).map(x => [Number(x.dow), x]));
        $("hoursForm").innerHTML = DOW.map(d => `
          <div style="padding:10px;border:1px solid rgba(15,23,42,.10);border-radius:16px;background:#fff">
            ${hourRow(d)}
          </div>
        `).join("");

        for(const d of DOW){
          const row = map.get(d.dow);
          if(row){
            $("o"+d.dow).value = String(row.open_time).slice(0,5);
            $("c"+d.dow).value = String(row.close_time).slice(0,5);
            $("x"+d.dow).checked = !!row.is_closed;
            $("o"+d.dow).disabled = !!row.is_closed;
            $("c"+d.dow).disabled = !!row.is_closed;
          }

          $("x"+d.dow).addEventListener("change", ()=>{
            const closed = $("x"+d.dow).checked;
            $("o"+d.dow).disabled = closed;
            $("c"+d.dow).disabled = closed;
          });
        }
      }catch{
        $("hoursBadge").textContent = "Error";
      }
    }

    async function saveHours(){
      $("saveHours").disabled = true;
      $("saveHours").textContent = "Guardando…";
      try{
        const rows = DOW.map(d => ({
          dow: d.dow,
          is_closed: $("x"+d.dow).checked,
          open_time: $("o"+d.dow).value,
          close_time: $("c"+d.dow).value
        }));
        const r = await fetch("/api/save_hours", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify({ rows })
        });
        const out = await r.json().catch(()=>({}));
        if(!r.ok || out.error) return show("Error: " + (out.error || ("HTTP " + r.status)), false);
        show("Horarios guardados ✅", true);
      }catch(e){
        show("Error: " + (e.message || "No se pudo guardar"), false);
      }finally{
        $("saveHours").disabled = false;
        $("saveHours").textContent = "Guardar horarios";
      }
    }

    // ---- PERFIL ----
    async function load(){
      const r = await fetch("/api/me");
      const out = await r.json().catch(()=>({}));
      if(!r.ok || out.error){
        $("summary").innerHTML = `<div style="font-weight:900">No has iniciado sesión.</div><div class="hint">Ve a login.</div>`;
        return;
      }

      ME = out.data;
      const isPro = (ME.plan_tier || "free") !== "free";

      $("planBadge").textContent = "Plan: " + (ME.plan_tier || "free");
      $("planBadge").className = "badge " + (isPro ? "ok" : "");

      $("summary").innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start">
          <div>
            <div style="font-weight:900;font-size:16px">${esc(ME.name)}</div>
            <div style="font-weight:850;color:rgba(15,23,42,.75);margin-top:4px">${esc(ME.category_primary)} • ${esc(ME.municipality)} • ${esc(ME.locality)}</div>
          </div>
          <span class="badge ${ME.verified ? "ok":""}">${ME.verified ? "Verificado" : "Sin verificar"}</span>
        </div>
        <div class="hint" style="margin-top:10px"><b>WhatsApp:</b> ${esc(ME.whatsapp)} ${ME.phone ? " • <b>Tel:</b> " + esc(ME.phone) : ""}</div>
      `;

      $("desc").value = ME.description || "";
      $("cov").value = ME.coverage_note || "";
      $("phone").value = ME.phone || "";
      $("delivery").checked = !!ME.delivery;
      $("pickup").checked = !!ME.pickup;
      $("dine").checked = !!ME.dine_in;
      $("avail").checked = !!ME.available_now;

      if(ME.kind !== "service"){
        $("avail").checked = false;
        $("avail").disabled = true;
      }else{
        $("avail").disabled = false;
      }

      if(!isPro){
        $("mediaBox").classList.add("lock");
        $("mediaBadge").textContent = "Bloqueado";
      }else{
        $("mediaBox").classList.remove("lock");
        $("mediaBadge").textContent = "Activo";
        $("mediaBadge").className = "badge ok";
      }

      renderThumbs();
      await loadHours();
    }

    async function saveBasic(){
      $("save").disabled = true;
      $("save").textContent = "Guardando…";
      try{
        const body = {
          description: $("desc").value,
          coverage_note: $("cov").value,
          phone: cleanPhone($("phone").value),
          delivery: $("delivery").checked,
          pickup: $("pickup").checked,
          dine_in: $("dine").checked,
          available_now: $("avail").checked
        };
        const r = await fetch("/api/update_profile", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(body)
        });
        const out = await r.json().catch(()=>({}));
        if(!r.ok || out.error) return show("Error: " + (out.error || ("HTTP " + r.status)), false);
        show("Guardado ✅", true);
        await load();
      }catch(e){
        show("Error: " + (e.message || "No se pudo guardar"), false);
      }finally{
        $("save").disabled = false;
        $("save").textContent = "Guardar cambios";
      }
    }

    // ---- SUBIDA SEGURA ----
    async function signedUpload(file, kind){
      // 1) pedir URL firmada
      const r1 = await fetch("/api/upload_url", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ kind, filename: file.name, contentType: file.type })
      });
      const out1 = await r1.json().catch(()=>({}));
      if(!r1.ok || out1.error) throw new Error(out1.error || ("HTTP "+r1.status));

      // 2) subir al signedUrl
      const put = await fetch(out1.signedUrl, {
        method: "PUT",
        headers: { "content-type": file.type },
        body: file
      });
      if(!put.ok) throw new Error("Falló la subida (PUT): " + put.status);

      // 3) guardar URL pública en DB
      const r3 = await fetch("/api/upload_finish", {
        method:"POST",
        headers:{ "content-type":"application/json" },
        body: JSON.stringify({ kind, publicUrl: out1.publicUrl })
      });
      const out3 = await r3.json().catch(()=>({}));
      if(!r3.ok || out3.error) throw new Error(out3.error || ("HTTP "+r3.status));

      return true;
    }

    async function uploadProfile(){
      const f = $("fileProfile").files?.[0];
      if(!f) return show("Selecciona una imagen.", false);

      $("upProfile").disabled = true;
      $("upProfile").textContent = "Subiendo…";
      try{
        await signedUpload(f, "profile");
        show("Foto actualizada ✅", true);
        $("fileProfile").value = "";
        await load();
      }catch(e){
        show("Error: " + (e.message || "No se pudo subir"), false);
      }finally{
        $("upProfile").disabled = false;
        $("upProfile").textContent = "Subir foto";
      }
    }

    async function uploadGallery(){
      const f = $("fileGallery").files?.[0];
      if(!f) return show("Selecciona una imagen.", false);

      $("upGallery").disabled = true;
      $("upGallery").textContent = "Subiendo…";
      try{
        await signedUpload(f, "gallery");
        show("Agregada a galería ✅", true);
        $("fileGallery").value = "";
        await load();
      }catch(e){
        show("Error: " + (e.message || "No se pudo subir"), false);
      }finally{
        $("upGallery").disabled = false;
        $("upGallery").textContent = "Subir a galería";
      }
    }

    $("save").addEventListener("click", saveBasic);
    $("saveHours").addEventListener("click", saveHours);
    $("upProfile").addEventListener("click", uploadProfile);
    $("upGallery").addEventListener("click", uploadGallery);

    $("logout").addEventListener("click", async ()=>{
      await fetch("/api/logout");
      location.href = "/index.html";
    });

    load();
  </script>
</body>
</html>
