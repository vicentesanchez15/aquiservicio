<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registrar • Aquiservicio</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --navy:#0b1220;
      --navy2:#0f1a33;

      --txt:#0f172a;
      --mut:#64748b;

      --card:rgba(255,255,255,.94);
      --glow:rgba(56,189,248,.22);
      --shadow:0 20px 70px rgba(2,6,23,.18);
      --r:20px;

      --ok:rgba(34,197,94,.12);
      --okbd:rgba(34,197,94,.30);
      --err:rgba(239,68,68,.12);
      --errbd:rgba(239,68,68,.30);

      --selectBg:rgba(2,6,23,.05);
      --selectBd:rgba(15,23,42,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(56,189,248,.14), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(99,102,241,.12), transparent 55%),
        linear-gradient(180deg, var(--navy), var(--navy2));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .shell{width:min(920px, 100%)}
    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      border-radius: calc(var(--r) + 10px);
      overflow:hidden;
      backdrop-filter: blur(10px);
      animation: in .35s ease-out;
    }
    @keyframes in{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .main{padding:18px 14px 18px}

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .title{
      margin:0;
      font-weight:900;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-size:14px;
      color:rgba(15,23,42,.82);
    }
    .back{
      text-decoration:none;
      font-weight:900;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      padding:10px 12px;
      border-radius:999px;
      color:var(--txt);
    }

    .progress{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      margin:12px 0 14px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      border:2px solid rgba(15,23,42,.18);
      background:transparent;
    }
    .dot.on{
      border-color: rgba(56,189,248,.55);
      background: rgba(56,189,248,.25);
      box-shadow:0 0 0 6px rgba(56,189,248,.10);
    }

    .stepTitle{
      text-align:center;
      margin:0;
      font-size:18px;
      font-weight:900;
      letter-spacing:.02em;
      background: linear-gradient(90deg, rgba(56,189,248,.85), rgba(99,102,241,.85));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .sub{
      text-align:center;
      margin:6px 0 0;
      color: rgba(15,23,42,.70);
      font-weight:700;
      font-size:13px;
      line-height:1.4;
    }

    label{
      display:block;
      font-size:12px;
      font-weight:900;
      color: rgba(15,23,42,.70);
      margin-bottom:6px;
      letter-spacing:.02em;
      text-transform:uppercase;
    }

    input, select, textarea{
      width:100%;
      border-radius:16px;
      padding:12px 12px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      font-weight:800;
      font-size:14px;
      outline:none;
      font-family:inherit;
    }
    textarea{min-height:96px; resize:vertical}

    select{
      border:1px solid var(--selectBd);
      background: var(--selectBg);
      appearance:none;
    }
    input:focus, select:focus, textarea:focus{
      box-shadow:0 0 0 4px var(--glow);
      border-color: rgba(56,189,248,.35);
      background:#fff;
    }

    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:14px;
    }
    @media (min-width:760px){ .grid{grid-template-columns:1fr 1fr;} }

    .chipBox{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:18px;
      padding:12px;
      margin-top:12px;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      font-weight:900;
      font-size:13px;
      color:rgba(15,23,42,.80);
    }
    .chips label{
      display:flex;
      align-items:center;
      gap:8px;
      margin:0;
      font-weight:900;
      color:rgba(15,23,42,.80);
      text-transform:none;
      letter-spacing:0;
    }
    .chips input{width:auto}

    .hint{
      font-size:12px;
      color:rgba(15,23,42,.65);
      font-weight:800;
      margin-top:8px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:14px;
    }
    .btn{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:999px;
      padding:12px 14px;
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(56,189,248,.18), rgba(99,102,241,.12));
      border-color: rgba(56,189,248,.35);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .msg{
      margin-top:14px;
      border-radius:18px;
      padding:12px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(2,6,23,.03);
      font-weight:900;
      font-size:13px;
      text-align:center;
      display:none;
      word-break:break-word;
    }
    .msg.ok{background:var(--ok); border-color:var(--okbd)}
    .msg.err{background:var(--err); border-color:var(--errbd)}

    .hp{display:none !important}
    .review{
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
      border-radius:18px;
      padding:12px;
      margin-top:12px;
      font-weight:850;
      color:rgba(15,23,42,.80);
      font-size:13px;
      line-height:1.6;
    }
    .review b{color:rgba(15,23,42,.98)}
  </style>
</head>

<body>
  <div class="shell">
    <div class="card">
      <div class="main">
        <div class="top">
          <h1 class="title">Registro de negocio</h1>
          <a class="back" href="index.html">← Inicio</a>
        </div>

        <div class="progress" aria-hidden="true">
          <span class="dot on" id="d1"></span>
          <span class="dot" id="d2"></span>
        </div>

        <p class="stepTitle" id="stepTitle">Paso 1 de 2</p>
        <p class="sub" id="stepSub">Datos principales para aparecer bien.</p>

        <form id="f">
          <input class="hp" id="hp" autocomplete="off" tabindex="-1" />

          <!-- PASO 1 -->
          <div id="step1">
            <div class="grid">
              <div>
                <label for="kind">Tipo</label>
                <select id="kind" required>
                  <option value="food">Comida</option>
                  <option value="service">Servicios</option>
                </select>
                <div class="hint">Esto define qué opciones podrás marcar.</div>
              </div>

              <div>
                <label for="municipality">Municipio</label>
                <select id="municipality" required disabled>
                  <option>Cargando…</option>
                </select>
                <div class="hint">Se toma del inicio automáticamente.</div>
              </div>
            </div>

            <div class="grid">
              <div>
                <label for="locality">Localidad</label>
                <select id="locality" required disabled>
                  <option>Selecciona municipio…</option>
                </select>
                <div class="hint">Se llena desde tu base de datos.</div>
              </div>

              <div>
                <label for="name">Nombre del negocio</label>
                <input id="name" placeholder="Ej: Tacos Juan" required />
              </div>
            </div>

            <div class="grid">
              <div>
                <label for="category_primary">Categoría principal</label>
                <input id="category_primary" placeholder="Ej: tacos / sushi / dentista / plomero" required />
                <div class="hint">Lo principal que quieres que vean.</div>
              </div>
              <div>
                <label for="coverage_note">Zona de cobertura (opcional)</label>
                <input id="coverage_note" placeholder="Ej: solo centro / Altata y cercas" />
              </div>
            </div>

            <div class="grid">
              <div style="grid-column:1/-1">
                <label for="description">Descripción</label>
                <textarea id="description" placeholder="Ej: Vendemos tacos y también tortas. Domicilio. Horario 7pm–1am."></textarea>
                <div class="hint">Corta, clara, sin rollo.</div>
              </div>
            </div>

            <div class="chipBox">
              <label>Marca todo lo que ofreces</label>

              <div class="chips" id="offerFood">
                <label><input type="checkbox" value="tacos"> Tacos</label>
                <label><input type="checkbox" value="tortas"> Tortas</label>
                <label><input type="checkbox" value="hamburguesas"> Hamburguesas</label>
                <label><input type="checkbox" value="pizza"> Pizza</label>
                <label><input type="checkbox" value="sushi"> Sushi</label>
                <label><input type="checkbox" value="mariscos"> Mariscos</label>
                <label><input type="checkbox" value="pollo-asado"> Pollo asado</label>
                <label><input type="checkbox" value="cafe-y-postres"> Café y postres</label>
                <label><input type="checkbox" value="antojitos"> Antojitos</label>
                <label><input type="checkbox" value="comida-corrida"> Comida corrida</label>
              </div>

              <div class="chips" id="offerService" style="display:none">
                <label><input type="checkbox" value="plomero"> Plomero</label>
                <label><input type="checkbox" value="mecanico"> Mecánico</label>
                <label><input type="checkbox" value="tecnico"> Técnico (cel/PC)</label>
                <label><input type="checkbox" value="cerrajero"> Cerrajero</label>
                <label><input type="checkbox" value="albanil"> Albañil</label>
                <label><input type="checkbox" value="dentista"> Dentista</label>
                <label><input type="checkbox" value="mandados"> Mandaditos</label>
                <label><input type="checkbox" value="taxis"> Taxis</label>
              </div>

              <div class="hint">Entre más marques, mejor te encuentran.</div>
            </div>

            <div class="actions">
              <button class="btn primary" type="button" id="next">Continuar →</button>
            </div>
          </div>

          <!-- PASO 2 -->
          <div id="step2" style="display:none;">
            <div class="grid">
              <div>
                <label for="whatsapp">WhatsApp</label>
                <input id="whatsapp" placeholder="6671234567" inputmode="numeric" required />
                <div class="hint">Solo números.</div>
              </div>
              <div>
                <label for="phone">Número para llamadas (opcional)</label>
                <input id="phone" placeholder="Opcional" inputmode="numeric" />
              </div>
            </div>

            <div class="chipBox">
              <label>¿Cómo atiendes?</label>
              <div class="chips">
                <label><input type="checkbox" id="delivery"> Servicio a domicilio</label>
                <label><input type="checkbox" id="pickup"> Ordena y recoge</label>
                <label><input type="checkbox" id="dine_in"> Solo sucursal</label>
              </div>
              <div class="hint">Esto aparece como “Domicilio / Pick up / Sucursal”.</div>
            </div>

            <div class="chipBox" id="serviceNowBox" style="display:none">
              <label>Servicios</label>
              <div class="chips">
                <label><input type="checkbox" id="available_now"> Disponible ahora</label>
              </div>
              <div class="hint">Solo para servicios.</div>
            </div>

            <div class="chipBox">
              <label>¿Qué escribe la gente para encontrarte? (opcional)</label>

              <div class="chips" id="hintsFood">
                <label><input type="checkbox" value="carne asada"> Carne asada</label>
                <label><input type="checkbox" value="domicilio"> Domicilio</label>
                <label><input type="checkbox" value="abierto"> Abierto</label>
                <label><input type="checkbox" value="promociones"> Promociones</label>
                <label><input type="checkbox" value="barato"> Barato</label>
                <label><input type="checkbox" value="rapido"> Rápido</label>
              </div>

              <div class="chips" id="hintsService" style="display:none">
                <label><input type="checkbox" value="urgente"> Urgente</label>
                <label><input type="checkbox" value="24 horas"> 24 horas</label>
                <label><input type="checkbox" value="a domicilio"> A domicilio</label>
                <label><input type="checkbox" value="barato"> Barato</label>
                <label><input type="checkbox" value="rapido"> Rápido</label>
              </div>

              <div class="hint">No dice “tags”. Son palabras para buscador.</div>
            </div>

            <div class="review" id="review"></div>

            <div class="actions">
              <button class="btn" type="button" id="back">← Volver</button>
              <button class="btn primary" type="submit" id="send">Enviar solicitud ✅</button>
            </div>

            <div class="msg" id="msg"></div>
          </div>
        </form>

      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const step1 = $("step1");
    const step2 = $("step2");
    const d1 = $("d1");
    const d2 = $("d2");
    const stepTitle = $("stepTitle");
    const stepSub = $("stepSub");
    const msg = $("msg");
    const review = $("review");

    function showMsg(text, ok=true){
      msg.style.display = "block";
      msg.className = "msg " + (ok ? "ok" : "err");
      msg.textContent = text;
    }
    function hideMsg(){ msg.style.display = "none"; }

    function cleanPhone(s){
      return (s || "").toString().replace(/\D/g, "").slice(0, 15);
    }
    function checkedValues(containerId){
      return [...document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`)]
        .map(i => i.value.trim())
        .filter(Boolean);
    }

    function goStep(n){
      hideMsg();
      if(n === 1){
        step1.style.display = "";
        step2.style.display = "none";
        d1.classList.add("on");
        d2.classList.remove("on");
        stepTitle.textContent = "Paso 1 de 2";
        stepSub.textContent = "Datos principales para aparecer bien.";
      } else {
        step1.style.display = "none";
        step2.style.display = "";
        d1.classList.remove("on");
        d2.classList.add("on");
        stepTitle.textContent = "Paso 2 de 2";
        stepSub.textContent = "Contacto y modalidad. Luego se revisa.";
        renderReview();
      }
    }

    function updateKindUI(){
      const kind = $("kind").value;
      $("offerFood").style.display = (kind === "food") ? "" : "none";
      $("offerService").style.display = (kind === "service") ? "" : "none";
      $("serviceNowBox").style.display = (kind === "service") ? "" : "none";
      $("hintsFood").style.display = (kind === "food") ? "" : "none";
      $("hintsService").style.display = (kind === "service") ? "" : "none";
    }

    function renderReview(){
      const kind = $("kind").value === "food" ? "Comida" : "Servicios";
      const municipality = $("municipality").value;
      const locality = $("locality").value;
      const name = $("name").value.trim();
      const category = $("category_primary").value.trim();
      const delivery = $("delivery").checked;
      const pickup = $("pickup").checked;
      const dine = $("dine_in").checked;

      const offerings = $("kind").value === "food" ? checkedValues("offerFood") : checkedValues("offerService");

      review.innerHTML = `
        <div><b>Tipo:</b> ${kind}</div>
        <div><b>Municipio:</b> ${municipality || "-"}</div>
        <div><b>Localidad:</b> ${locality || "-"}</div>
        <div><b>Negocio:</b> ${name || "-"}</div>
        <div><b>Categoría principal:</b> ${category || "-"}</div>
        <div><b>Ofrece:</b> ${offerings.length ? offerings.join(", ") : "-"}</div>
        <div><b>Modalidad:</b> ${(delivery?"Domicilio":"")}${(pickup? (delivery?", ":"") + "Ordena y recoge" : "")}${(dine? ((delivery||pickup)?", ":"") + "Sucursal" : "") || (!delivery&&!pickup&&!dine ? "-" : "")}</div>
      `;
    }

    async function loadMunicipalities(){
      const sel = $("municipality");
      sel.innerHTML = `<option>Cargando…</option>`;
      sel.disabled = true;

      try{
        const r = await fetch("/api/municipalities");
        const out = await r.json();
        const list = out?.data || [];

        sel.innerHTML = "";
        if(!list.length){
          sel.add(new Option("Navolato", "Navolato", true, true));
        } else {
          for(const m of list){
            const name = m.name || "";
            // igual que index: solo Navolato disponible por ahora
            const isNav = name.toLowerCase().includes("navolato");
            const label = isNav ? `${name} (Disponible)` : `${name} (Próximamente)`;
            const opt = new Option(label, name, false, false);
            opt.disabled = !isNav;
            sel.add(opt);
          }
        }

        const saved = localStorage.getItem("aq_city");
        const canUseSaved = saved && [...sel.options].some(o => o.value === saved && !o.disabled);
        if(canUseSaved){
          sel.value = saved;
        } else {
          const firstOk = [...sel.options].find(o => !o.disabled);
          sel.value = firstOk ? firstOk.value : "Navolato";
        }

        sel.disabled = false;
        localStorage.setItem("aq_city", sel.value);

      }catch(_){
        sel.innerHTML = "";
        sel.add(new Option("Navolato (Disponible)", "Navolato", true, true));
        sel.disabled = false;
      }
    }

    async function loadLocalities(){
      const municipality = $("municipality").value;
      const sel = $("locality");
      sel.innerHTML = `<option>Cargando…</option>`;
      sel.disabled = true;

      try{
        const r = await fetch("/api/localities?municipality=" + encodeURIComponent(municipality));
        const out = await r.json();
        const list = out?.data || [];

        sel.innerHTML = "";
        if(!list.length){
          sel.add(new Option("No disponible aún", "", true, true));
        } else {
          sel.add(new Option("Selecciona…", "", true, true));
          for(const z of list){
            const name = z.name || "";
            sel.add(new Option(name, name, false, false));
          }
        }

        // si ya había guardado localidad
        const savedLoc = localStorage.getItem("aq_locality_" + municipality);
        if(savedLoc && [...sel.options].some(o => o.value === savedLoc)){
          sel.value = savedLoc;
        }

        sel.disabled = false;

      }catch(_){
        sel.innerHTML = "";
        sel.add(new Option("Error al cargar", "", true, true));
        sel.disabled = false;
      }
    }

    $("kind").addEventListener("change", updateKindUI);

    $("municipality").addEventListener("change", async () => {
      localStorage.setItem("aq_city", $("municipality").value);
      await loadLocalities();
    });

    $("locality").addEventListener("change", () => {
      const m = $("municipality").value;
      localStorage.setItem("aq_locality_" + m, $("locality").value);
    });

    $("next").addEventListener("click", () => {
      const name = $("name").value.trim();
      const category = $("category_primary").value.trim();
      const municipality = $("municipality").value;
      const locality = $("locality").value;

      if(!municipality) return showMsg("Falta seleccionar municipio.", false);
      if(!locality) return showMsg("Falta seleccionar localidad.", false);
      if(!name || name.length < 3) return showMsg("Falta el nombre del negocio.", false);
      if(!category || category.length < 2) return showMsg("Falta la categoría principal.", false);

      goStep(2);
    });

    $("back").addEventListener("click", () => goStep(1));

    $("f").addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMsg();

      const whatsapp = cleanPhone($("whatsapp").value);
      if(whatsapp.length < 10) return showMsg("WhatsApp inválido.", false);

      const kind = $("kind").value;

      const offerings = (kind === "food")
        ? checkedValues("offerFood")
        : checkedValues("offerService");

      const hints = (kind === "food")
        ? checkedValues("hintsFood")
        : checkedValues("hintsService");

      const body = {
        hp: $("hp").value,

        kind,
        municipality: $("municipality").value,
        locality: $("locality").value,

        name: $("name").value.trim(),
        category_primary: $("category_primary").value.trim(),
        coverage_note: $("coverage_note").value.trim(),
        description: $("description").value.trim(),

        whatsapp,
        phone: cleanPhone($("phone").value) || "",

        delivery: $("delivery").checked,
        pickup: $("pickup").checked,
        dine_in: $("dine_in").checked,
        available_now: kind === "service" ? $("available_now").checked : false,

        offerings,
        hints
      };

      $("send").disabled = true;
      $("send").textContent = "Enviando…";

      try{
        const r = await fetch("/api/register", {
          method:"POST",
          headers:{ "content-type":"application/json" },
          body: JSON.stringify(body)
        });

        const text = await r.text();
        let out = {};
        try{ out = text ? JSON.parse(text) : {}; }catch(_){}

        if(!r.ok || out.error){
          showMsg("Error: " + (out.error || ("HTTP " + r.status)), false);
        } else {
          showMsg("Solicitud enviada ✅", true);
          $("f").reset();
          updateKindUI();
          goStep(1);
          await loadMunicipalities();
          await loadLocalities();
        }

      }catch(err){
        showMsg("Error: " + (err.message || "No se pudo enviar"), false);
      }finally{
        $("send").disabled = false;
        $("send").textContent = "Enviar solicitud ✅";
      }
    });

    // INIT
    (async () => {
      updateKindUI();
      goStep(1);
      await loadMunicipalities();
      await loadLocalities();
    })();
  </script>
</body>
</html>
