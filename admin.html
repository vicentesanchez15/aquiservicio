<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Aquiservicio</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800;900&display=swap" rel="stylesheet">

  <style>
    :root{--navy:#0b1220;--navy2:#0f1a33;--card:rgba(255,255,255,.94);--txt:#0f172a;--shadow:0 20px 70px rgba(2,6,23,.18)}
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Arial;color:var(--txt);
      background:radial-gradient(900px 600px at 10% 0%, rgba(56,189,248,.14), transparent 60%),
               radial-gradient(900px 600px at 90% 10%, rgba(99,102,241,.12), transparent 55%),
               linear-gradient(180deg, var(--navy), var(--navy2));
      min-height:100vh; padding:16px; display:flex; justify-content:center;
    }
    .wrap{width:min(980px,100%)}
    .card{background:var(--card); border-radius:22px; box-shadow:var(--shadow); padding:14px; overflow:hidden}
    h1{margin:0 0 10px; font-size:18px; letter-spacing:.08em; text-transform:uppercase}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input{
      width:min(420px,100%); padding:12px 14px; border-radius:14px; border:1px solid rgba(15,23,42,.16);
      font-weight:800; font-size:14px;
    }
    button{
      padding:12px 14px; border-radius:14px; border:1px solid rgba(15,23,42,.12);
      font-weight:900; cursor:pointer; background:#fff;
    }
    .btnPrimary{background:linear-gradient(180deg, rgba(56,189,248,.18), rgba(99,102,241,.12)); border-color: rgba(56,189,248,.35)}
    .list{margin-top:12px; display:grid; gap:10px}
    .item{background:#fff; border:1px solid rgba(15,23,42,.10); border-radius:18px; padding:12px}
    .meta{color:rgba(15,23,42,.65); font-weight:800; font-size:12px}
    .name{font-weight:900; font-size:16px; margin:4px 0 8px}
    .pill{display:inline-flex; padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px; border:1px solid rgba(15,23,42,.12); background:rgba(2,6,23,.02)}
    .ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.10)}
    .warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10)}
    .err{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.10)}
    .small{font-size:12px; color:rgba(15,23,42,.70); font-weight:800}
    .hr{height:1px; background:rgba(15,23,42,.08); margin:12px 0}
    pre{
      margin:10px 0 0;
      padding:10px;
      background:rgba(2,6,23,.04);
      border:1px solid rgba(15,23,42,.08);
      border-radius:14px;
      overflow:auto;
      font-size:12px;
      font-weight:800;
      color:rgba(15,23,42,.85);
      max-height:240px;
      white-space:pre-wrap;
      word-break:break-word;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin • Pendientes</h1>

      <div class="row">
        <input id="token" placeholder="ADMIN_PANEL_TOKEN (solo tú)" />
        <button class="btnPrimary" id="load">Cargar pendientes</button>
        <button id="debug">Debug API</button>
        <a href="index.html" class="small">← Inicio</a>
      </div>

      <div class="hr"></div>

      <div class="list" id="list"></div>
      <pre id="debugOut">Debug: listo.</pre>
    </div>
  </div>

  <script>
    const listEl = document.getElementById("list");
    const tokenEl = document.getElementById("token");
    const debugOut = document.getElementById("debugOut");

    function writeDebug(msg){
      debugOut.textContent = msg;
    }

    async function fetchWithTimeout(url, options = {}, ms = 8000){
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), ms);
      try{
        const res = await fetch(url, { ...options, signal: ctrl.signal });
        clearTimeout(id);
        return res;
      }catch(e){
        clearTimeout(id);
        throw e;
      }
    }

    async function apiGet(action){
      const token = tokenEl.value.trim();
      if(!token) return { error: "Falta ADMIN_PANEL_TOKEN" };

      const url = `/api/admin?action=${encodeURIComponent(action)}`;

      writeDebug(`Llamando: ${url}\nEnviando header x-admin-token: (sí)\nEsperando respuesta...`);

      let res;
      try{
        res = await fetchWithTimeout(url, {
          headers: { "x-admin-token": token }
        }, 8000);
      }catch(e){
        return { error: (e.name === "AbortError") ? "Timeout (8s). ¿Endpoint no responde?" : (e.message || String(e)) };
      }

      const text = await res.text().catch(() => "");
      writeDebug(`HTTP ${res.status}\nRespuesta cruda:\n${text || "(vacío)"}`);

      let json = null;
      try{ json = text ? JSON.parse(text) : {}; }catch(_){}

      if(!res.ok){
        return { error: json?.error || `HTTP ${res.status}` };
      }
      return json || {};
    }

    function itemHTML(b){
      return `
        <div class="item">
          <div class="meta">${new Date(b.created_at).toLocaleString()} • ${b.kind} • ${b.category_slug} • ${b.locality}</div>
          <div class="name">${b.name}</div>
          <div class="row">
            <span class="pill warn">${(b.status || "pending").toUpperCase()}</span>
            <span class="pill">${b.whatsapp || ""}</span>
          </div>
          <div class="small">ID: ${b.id}</div>
        </div>
      `;
    }

    async function load(){
      listEl.innerHTML = `<div class="pill warn">Cargando...</div>`;
      const out = await apiGet("list_pending");

      if(out.error){
        listEl.innerHTML = `<div class="pill err">Error: ${out.error}</div>`;
        return;
      }

      const data = out.data || [];
      if(!data.length){
        listEl.innerHTML = `<div class="pill ok">No hay solicitudes pendientes ✅</div>`;
        return;
      }

      listEl.innerHTML = data.map(itemHTML).join("");
    }

    document.getElementById("load").addEventListener("click", load);

    document.getElementById("debug").addEventListener("click", async () => {
      const out = await apiGet("count_pending");
      if(out.error) return alert(out.error);
      alert("pending_count = " + out.pending_count);
    });

    // Mensaje para confirmar que el JS sí está corriendo
    writeDebug("Debug: JS cargó OK. Listo para llamar /api/admin");
  </script>
</body>
</html>
